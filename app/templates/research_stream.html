{% extends "base.html" %}

{% block content %}
    <div class="container">
        <h1>{{ title }}</h1>
        <p><strong>LinkedIn URL:</strong> <a href="{{ research.candidate.linkedin_url }}" target="_blank">{{ research.candidate.linkedin_url }}</a></p>
        <hr>
        
        <h3>Research Progress:</h3>
        <div id="stream-container" class="card">
            <div class="card-body">
                <pre id="stream-content" style="white-space: pre-wrap; word-wrap: break-word;"></pre>
            </div>
        </div>
        <div id="status" class="mt-3">
            <p>Research in progress... This may take several minutes. Waiting for the first update from the research model. <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span></p>
        </div>
        <a href="{{ url_for('main.project', project_id=research.project_id) }}" class="btn btn-secondary mt-3" style="display: none;" id="back-to-project">Back to Project</a>
    </div>
{% endblock %}

{% block scripts %}
    {{ super() }}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const streamContent = document.getElementById('stream-content');
            const status = document.getElementById('status');
            const backToProjectBtn = document.getElementById('back-to-project');
                        const researchId = parseInt('{{ research.id }}', 10);
            
            const eventSource = new EventSource(`/stream/${researchId}`);
            
            eventSource.onmessage = function(event) {
                if (status.textContent.includes('Waiting')) {
                    status.innerHTML = '<p>Receiving data...</p>';
                }
                try {
                    const data = JSON.parse(event.data);

                    if (data.error) {
                        streamContent.innerHTML += `<p class="text-danger"><strong>Error:</strong> ${data.error}</p>`;
                        eventSource.close();
                        return;
                    }
                    
                    // For now, just display the raw JSON to see the structure
                    streamContent.textContent += JSON.stringify(data, null, 2) + '\n';

                } catch (e) {
                    console.error('Failed to parse JSON from stream:', event.data, e);
                }
            };
            
            eventSource.onerror = function(err) {
                console.error("EventSource failed:", err);
                status.innerHTML = '<p class="text-success">Research complete!</p>';
                backToProjectBtn.style.display = 'block';
                eventSource.close();
            };
        });
    </script>
{% endblock %}
